#!/usr/bin/env python
# -*- coding: utf-8 -*-

from tkinter import ttk
import tkinter as tk
import sqlite3 as sql
import sys

def pressed():
    entry = pEntry.get()

    for i in tree.get_children():
        tree.delete(i)

    lookup(entry)
    print(entry)

def lookup(entry):
    print('looking up database')
    con = None

    try:
        con = sql.connect('proj.db')
        
        cur = con.cursor()

        cur.execute("SELECT * FROM player WHERE playerName LIKE \'" + entry + "\'")
        players = cur.fetchall()
        cur.execute("SELECT * FROM player NATURAL JOIN gameStats WHERE playerName LIKE \'" + entry + "\'")
        rows = cur.fetchall()

        for row in players:
            tree.insert('', 0, iid = row[0], values = row[1:2])


        for row in rows:
            tree.insert(row[0], 1, values = ("",) + row[2:22])
        
    except sql.Error as e:
        
        print("Error %s:" % e.args[0])
        sys.exit(1)
        
    finally:
        
        if con:
            con.close()

def sort_by_column(tree, col, reverse):
    l = [(tree.set(k, col), k) for k in tree.get_children('')]
    l.sort(reverse=reverse)

    # rearrange items in sorted positions
    for index, (val, k) in enumerate(l):
        tree.move(k, '', index)

    # reverse sort
    tree.heading(col, command=lambda _col=col: sort_by_column(tree, _col, not reverse))


top = tk.Tk()

psearchFrame = tk.Frame(top)
psearchFrame.pack(side = tk.TOP)
lowerFrame = tk.Frame(top)
lowerFrame.pack(side = tk.BOTTOM)

pButton = tk.Button(psearchFrame, text = 'Search', command = pressed)
pButton.pack(side = tk.LEFT, pady = 20, padx = 20)

pLabel = tk.Label(psearchFrame, text="Player")
pLabel.pack( side = tk.LEFT)
pEntry = tk.Entry(psearchFrame, bd =5)
pEntry.pack(side = tk.RIGHT)

columns = ('Name', 'game', 'pa', 'atBats', 'runs', 'hits', 'b2', 'b3', 'hr', 'rbi', 'sb', 'cs', 'bb', 'so', 'p_innings', 'p_hits', 'p_runs', 'p_er', 'p_hr', 'p_bb', 'p_so')

tree = ttk.Treeview(top, columns=columns, show='headings')

for col in columns:
    tree.heading(col, text=col, command=lambda _col=col: sort_by_column(tree, _col, False))
    if(col == 'Name'):
        tree.column(col, width = 80)
    else:
        tree.column(col, width = 30)

tree.pack()

top.mainloop()
